<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Test</title>
  <style>
    body { font-family: sans-serif; background: #f8fafc; margin: 0; }
    #chat { max-width: 500px; margin: 2em auto; background: #fff; border-radius: 10px; box-shadow: 0 0 10px #0002; padding: 2em; }
    #msgs { min-height: 200px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1em; padding: 1em; overflow-y: auto; height: 300px; }
    .mine { background: #dbeafe; }
    .msg { margin: 0.2em 0; padding: 0.2em 0.7em; border-radius: 6px; }
    #sendbox { display: flex; gap: 0.5em; }
    #input { flex: 1; }
  </style>
</head>
<body>
  <div id="chat">
    <div id="msgs"></div>
    <form id="sendbox" autocomplete="off">
      <input id="input" placeholder="Type message..." />
      <button type="submit">Send</button>
    </form>
    <div id="status"></div>
  </div>
  <script>
    let ws, username;
    username = prompt("Enter your name:");
    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws";
    const msgs = document.getElementById('msgs');
    const input = document.getElementById('input');
    const status = document.getElementById('status');
    const sendbox = document.getElementById('sendbox');

    function appendMessage(user, text) {
      const div = document.createElement('div');
      div.className = 'msg' + (user === username ? ' mine' : '');
      div.textContent = `${user}: ${text}`;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function connect() {
      ws = new WebSocket(wsUrl);
      ws.onopen = () => {
        status.textContent = "Connected!";
        ws.send(JSON.stringify({ user: username }));
      };
      ws.onclose = () => {
        status.textContent = "Disconnected. Reconnecting...";
        setTimeout(connect, 2000);
      };
      ws.onerror = () => status.textContent = "WebSocket error!";
      ws.onmessage = (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          appendMessage(msg.user, msg.text);
        } catch {}
      };
    }

    sendbox.onsubmit = (e) => {
      e.preventDefault();
      if (!input.value.trim()) return;
      ws.send(JSON.stringify({ text: input.value }));
      input.value = "";
    };

    connect();
  </script>
</body>
</html>
