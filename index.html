<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Test with Typing Indicator</title>
  <style>
    body { font-family: sans-serif; background: #f8fafc; margin: 0; }
    #chat { max-width: 500px; margin: 2em auto; background: #fff; border-radius: 10px; box-shadow: 0 0 10px #0002; padding: 2em; }
    #msgs { min-height: 200px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1em; padding: 1em; overflow-y: auto; height: 300px; }
    .mine { background: #dbeafe; }
    .msg { margin: 0.2em 0; padding: 0.2em 0.7em; border-radius: 6px; }
    #sendbox { display: flex; gap: 0.5em; }
    #input { flex: 1; }
    #status { font-style: italic; color: #555; height: 1.2em; }
  </style>
</head>
<body>
  <div id="chat">
    <div id="msgs"></div>
    <form id="sendbox" autocomplete="off">
      <input id="input" placeholder="Type message..." />
      <button type="submit">Send</button>
    </form>
    <div id="status"></div>
  </div>
  <script>
    let ws, username;
    username = prompt("Enter your name:");
    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws";
    const msgs = document.getElementById('msgs');
    const input = document.getElementById('input');
    const status = document.getElementById('status');
    const sendbox = document.getElementById('sendbox');

    let typingTimeout;
    const TYPING_DELAY = 10000; // ms

    function sendTyping(isTyping) {
      ws.send(JSON.stringify({ typing: isTyping }));
    }

    input.addEventListener('input', () => {
      // on first keystroke, notify typing
      if (typingTimeout === undefined) {
        sendTyping(true);
      }
      clearTimeout(typingTimeout);
      // after delay, send stop typing
      typingTimeout = setTimeout(() => {
        sendTyping(false);
        typingTimeout = undefined;
      }, TYPING_DELAY);
    });

    function appendMessage(user, text) {
      const div = document.createElement('div');
      div.className = 'msg' + (user === username ? ' mine' : '');
      div.textContent = `${user}: ${text}`;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function showTyping(user) {
      status.textContent = `${user} is typing...`;
    }

    function clearTyping() {
      status.textContent = '';
    }

    function connect() {
      ws = new WebSocket(wsUrl);
      ws.onopen = () => {
        status.textContent = "Connected!";
        ws.send(JSON.stringify({ user: username }));
      };
      ws.onclose = () => {
        status.textContent = "Disconnected. Reconnecting...";
        setTimeout(connect, 2000);
      };
      ws.onerror = () => status.textContent = "WebSocket error!";
      ws.onmessage = (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.typing) {
            showTyping(msg.user);
            // clear after a short while in case no stop event arrives
            setTimeout(clearTyping, TYPING_DELAY + 200);
          } else if (msg.text) {
            clearTyping();
            appendMessage(msg.user, msg.text);
          }
        } catch {}
      };
    }

    sendbox.onsubmit = (e) => {
      e.preventDefault();
      if (!input.value.trim()) return;
      // if user was typing, send stop typing immediately
      if (typingTimeout !== undefined) {
        clearTimeout(typingTimeout);
        sendTyping(false);
        typingTimeout = undefined;
      }
      ws.send(JSON.stringify({ text: input.value }));
      input.value = "";
    };

    connect();
  </script>
</body>
</html>